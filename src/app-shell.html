<link rel="import"
  href="../bower_components/polymer/polymer-element.html">
<link rel="import"
  href="../bower_components/app-route/app-location.html">
<link rel="import"
  href="../bower_components/app-route/app-route.html">
<link rel="import"
  href="../bower_components/iron-pages/iron-pages.html">
<link rel="import"
  href="../bower_components/iron-selector/iron-selector.html">
<link rel="import"
  href="../bower_components/paper-toast/paper-toast.html">

<link rel="import"
  href="routes/page-home.html">
<link rel="import"
  href="app-icons.html">

<dom-module id="app-shell">
  <template>
    <style>
       :host {
        height: 100vh;
        display: block;
      }
      
      .toast-reload a{
        color: white;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>
   
    <iron-pages selected="[[page]]"
      attr-for-selected="name"
      fallback-selection="view404"
      role="main">

      <!--start app-pages-->
      <page-home name="home"></page-home>
      <page-login name="login"></page-login>
      <!--end app-pages-->
    </iron-pages>

    <paper-toast id="notificationToast"
      duration="0"
      on-click="handleNotificationAction"
      opened="[[notify.open]]"
      text="New version available">
      <a href="#">Reload to update</a>
    </paper-toast>

  </template>

  <script>
    class AppShell extends Polymer.Element {
      static get is() { return 'app-shell'; }
      static get properties() {
        return {
          notify: {
            type: Object,
            observer: '_notify'
          },
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subroute: Object
        };
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        if (window.performance && performance.mark)
          performance.mark('app-shell.connected');

      }

      ready() {
        super.ready();
        const vm = this;
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.onstatechange = function (e) {
            if (e.target.state === 'redundant') {
              vm.$.notificationToast.open();
            }
          };
        }
      }

      handleNotificationAction() {
        window.location.reload(true);
        this.$.notificationToast.close();
      }

      _routePageChanged(page) {
        this.page = page || 'home';
      }

      _pageChanged(page) {
        var resolvedPageUrl = this.resolveUrl('routes/page-' + page + '.html');

        Polymer.importHref(
          resolvedPageUrl,
          null,
          null,
          true);
      }
    }

    window.customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>